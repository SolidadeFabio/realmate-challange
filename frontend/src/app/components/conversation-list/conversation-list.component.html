<div class="conversation-list-container">
  <div class="bg-white border-bottom p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Conversas</h5>
      <div class="d-flex align-items-center gap-2">
        <span class="badge" [class.bg-success]="connectionStatus" [class.bg-danger]="!connectionStatus">
          <i class="bi" [class.bi-wifi]="connectionStatus" [class.bi-wifi-off]="!connectionStatus"></i>
          {{ connectionStatus ? 'Online' : 'Offline' }}
        </span>
        <button class="btn btn-sm btn-outline-primary" (click)="onRefresh()" [disabled]="!connectionStatus || loading">
          <i class="bi bi-arrow-clockwise" [class.spinning]="loading"></i>
        </button>
      </div>
    </div>

    <div class="d-flex flex-column gap-2">
      <input
        type="text"
        class="form-control form-control-sm"
        placeholder="Buscar conversas..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()">

      <select
        class="form-select form-select-sm"
        [(ngModel)]="statusFilter"
        (ngModelChange)="applyFilters()">
        <option value="">Todas</option>
        <option value="OPEN">Abertas</option>
        <option value="CLOSED">Fechadas</option>
      </select>
    </div>
  </div>

  <div class="list-content" #listContainer (scroll)="onScroll($event)">
    @if (loading && filteredConversations.length === 0) {
      <div class="d-flex flex-column align-items-center justify-content-center p-5 text-muted">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Carregando conversas...</p>
      </div>
    } @else if (filteredConversations.length === 0) {
      <div class="d-flex flex-column align-items-center justify-content-center p-5 text-muted">
        <i class="bi bi-chat-dots fs-1 mb-3"></i>
        <p>Nenhuma conversa encontrada</p>
      </div>
    } @else {
      @for (conversation of filteredConversations; track conversation.id) {
        <div
          #conversationItem
          class="conversation-item bg-white border-bottom p-3"
          [class.active]="selectedConversationId === conversation.id"
          [attr.data-conversation-id]="conversation.id"
          (click)="selectConversation(conversation)">

          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="fw-semibold small">{{ conversation.id.substring(0, 8) }}</span>
            <span class="text-muted small">
              {{ formatTime(conversation.last_message?.timestamp) }}
            </span>
          </div>

          <div class="mb-2">
            <p class="mb-0 text-muted small text-truncate">
              {{ getConversationPreview(conversation) }}
            </p>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <span class="badge" [class.bg-success]="conversation.status === 'OPEN'" [class.bg-secondary]="conversation.status === 'CLOSED'">
              {{ conversation.status === 'OPEN' ? 'Aberta' : 'Fechada' }}
            </span>
            @if (conversation.unread_count && conversation.unread_count > 0) {
              <span class="badge bg-primary">{{ conversation.unread_count }}</span>
            }
          </div>
        </div>
      }

      @if (loadingMore && filteredConversations.length > 0) {
        <div class="d-flex justify-content-center p-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Loading more...</span>
          </div>
          <span class="ms-2 text-muted small">Carregando mais...</span>
        </div>
      }

      @if (!hasMore && filteredConversations.length > 0 && !loadingMore) {
        <div class="text-center p-3 text-muted small">
          <i class="bi bi-check-circle"></i>
          Todas as conversas carregadas
        </div>
      }
    }
  </div>
</div>