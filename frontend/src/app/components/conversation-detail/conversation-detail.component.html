<div class="conversation-detail-container">
  @if (!conversation) {
    <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
      <i class="bi bi-chat-text fs-1 mb-3"></i>
      <h5>Selecione uma conversa</h5>
      <p>Escolha uma conversa na lista para ver as mensagens</p>
    </div>
  } @else {
    <div class="bg-white border-bottom p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-0">Conversa #{{ conversation.id.substring(0, 8) }}</h6>
          <div class="d-flex gap-3 mt-1">
            <small class="text-muted">
              <i class="bi bi-circle-fill" [class.text-success]="conversation.status === 'OPEN'" [class.text-secondary]="conversation.status === 'CLOSED'"></i>
              {{ conversation.status === 'OPEN' ? 'Aberta' : 'Fechada' }}
            </small>
            <small class="text-muted">
              <i class="bi bi-chat-dots"></i>
              {{ conversation.messages?.length || 0 }} mensagens
            </small>
          </div>
        </div>
        @if (conversation.status === 'OPEN') {
          <button class="btn btn-outline-danger btn-sm" (click)="onCloseConversation()" [disabled]="loading">
            <i class="bi bi-x-circle"></i>
            Fechar Conversa
          </button>
        }
      </div>
    </div>

    <div class="messages-container flex-grow-1 overflow-auto p-3 bg-light">
      @for (message of conversation.messages || []; track message.id) {
        <div class="mb-3 d-flex" [class.justify-content-end]="message.direction === 'SENT'">
          <div class="message-bubble" [ngClass]="{
            'bg-primary text-white': message.direction === 'SENT',
            'bg-white': message.direction === 'RECEIVED'
          }">
            <p class="mb-1">{{ message.content }}</p>
            <small class="d-block" [class.text-white-50]="message.direction === 'SENT'" [class.text-muted]="message.direction === 'RECEIVED'">
              {{ formatTime(message.timestamp) }}
            </small>
          </div>
        </div>
      }
    </div>

    @if (conversation.status === 'OPEN') {
      <div class="bg-white border-top p-3">
        <form (submit)="onSendMessage($event)" class="d-flex gap-2">
          <input
            type="text"
            class="form-control"
            placeholder="Digite sua mensagem..."
            [(ngModel)]="newMessage"
            name="message"
            [disabled]="loading">

          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!newMessage || !newMessage.trim() || loading">
            <i class="bi bi-send"></i>
          </button>
        </form>
      </div>
    } @else {
      <div class="bg-light border-top p-3 text-center text-muted">
        <i class="bi bi-lock"></i>
        Conversa fechada
      </div>
    }
  }
</div>

<app-confirm-modal
  [show]="showCloseModal"
  title="Fechar Conversa"
  message="Tem certeza que deseja fechar esta conversa? Esta ação não pode ser desfeita."
  confirmText="Fechar Conversa"
  cancelText="Cancelar"
  (confirmed)="confirmClose()"
  (cancelled)="cancelClose()">
</app-confirm-modal>